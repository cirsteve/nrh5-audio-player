<!DOCTYPE html>
<html>
<head>
    <title>HTML5 Audio Lab</title>

</head>
<body>
<h4>Now Playing:</h4>
<h3 id="song"></h3>
<p>By <span id="artist"></span> from the album <span id="album"></span></p>
<br />
<h4>Upcoming on this playlist</h4>
<ol id="playlist"></ol>

<button id="skip" type="button">Skip Track</button>
<audio id="audio-player" autoplay src="" type="audio/ogg" >

</audio>

<script>
//initiate the connection to listen to server sid events on
var trackEvent = new EventSource('stream');

//add new track listener onto SSE object to load new song
trackEvent.addEventListener('new-track',function(message) {
    advanceTrack(JSON.parse(message.data));
}, false);

//add new playlist listener to render new playlsit
trackEvent.addEventListener('playlist', function(message) {
    renderPlaylist(message.data);
}, false);

//create convenience references to dom elements
var audio = document.getElementById("audio-player"),
    song = document.getElementById("song"),
    artist = document.getElementById("artist"),
    album = document.getElementById("album"),
    playlist = document.getElementById("playlist");

//utility function to render upcoming playlist
var renderPlaylist = function(list) {
    playlist.innerHTML = '';
    list = JSON.parse(list);
    list.forEach(function(track) {
            var t = JSON.parse(track),
                p = document.createElement("p"),
                li = document.createElement("li");
            console.log(t);
            p.innerHTML = t.song + ' by ' + t.artist + ' from ' + t.album;
            li.appendChild(p);
            playlist.appendChild(li);
        });
};

//set the audio src and html elements for new track
var advanceTrack = function(track) {
    audio.src = track.url;
    song.innerHTML = track.song;
    artist.innerHTML = track.artist;
    album.innerHTML = track.album;
};

//ajax get request to advance track url to initiate skip routine
var requestSkip = function() {
    var req = new XMLHttpRequest();
    req.open('GET', 'advance-track', true);
    req.send();

    if (req.status === "200") {
        console.log(req.statusText);
    }
};
document.getElementById("skip").onclick=requestSkip;

</script>
</body>


</html>

